---
platform: linux

image_resource:
  type: docker-image
  source:
    repository: governmentpaas/awscli

inputs:
  - name: source

params:
  AWS_ACCESS_KEY_ID: ((secrets.role-putter-access-key-id))
  AWS_SECRET_ACCESS_KEY: ((secrets.role-putter-secret-access-key))
  APP_NAME: ((app-name))

run:
  path: sh
  args:
    - -ec
    - |
      export ROLE_NAME=$(cat ./source/deploy.json | jq -r '.role_name')
      aws iam get-role-policy --role-name $ROLE_NAME --policy-name $APP_NAME | jq -r '.PolicyDocument' > ./source/existing_iam_policy.json
      export ARE_SAME=$(jq --argfile a ./source/iam_policy.json --argfile b ./source/existing_iam_policy.json -n '$a==$b')
      if [ \"$ARE_SAME\" != \"true\" ]; then
        jq -S . ./source/iam_policy.json > new.json
        jq -S . ./source/existing_iam_policy.json > current.json
        echo -e '\033[0;31mChange in iam_policy.json'
        diff current.json new.json
        exit 166
      fi
      echo -e '\033[0;32mNo changes in iam_policy.json'
