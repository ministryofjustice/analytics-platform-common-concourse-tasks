---
platform: linux

image_resource:
  type: docker-image
  source:
    repository: gempesaw/curl-jq

inputs:
- name: webapp-source

outputs:
- name: deploy-params

params:
  IPS_DOM1:
  IPS_QUANTUM:
  IPS_102PF_WIFI:
  IPS_CLIVE_HOUSE:

run:
  path: sh
  args:
  - -ec
  - |
    jq --argjson ip "{
      \"102PF Wifi\": \"$IPS_102PF_WIFI\",
      \"Clive House Wifi\": \"$IPS_CLIVE_HOUSE_WIFI\",
      \"DOM1\": \"$IPS_DOM1\",
      \"QUANTUM\": \"$IPS_QUANTUM\"
    }" -r '{
      AuthProxy: {
        AuthenticationRequired: (.enable_authentication // true),
        IPRanges: (.allowed_ip_ranges // ["DOM1"]) | map($ip[.]) | join(",") | gsub("(?<x>[,.])"; "\\\(.x)")
      }
    }' < webapp-source/deploy.json > deploy-params/overrides.yaml
