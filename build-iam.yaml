platform: linux
inputs:
  - name: source
outputs:
  - name: source-out
image_resource:
  type: docker-image
  source:
    repository: python
    tag: alpine
run:
  path: sh
  args:
  - -ec
  - |
    cp -R ./source/. ./source-out/
    if [ -f ./source/iam_config.yaml ] && [ ! -f ./source/iam_policy.json ]; then
      echo 'Building iam_policy.json from iam_config.yaml'
      pip install iam_builder
      iam_builder -c ./source/iam_config.yaml -o ./source-out/iam_policy.json
    fi
